<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Countdown ขึ้นรถไฟ — บางซื่อ ↔ เชียงราก</title>
  <style>
    :root{
      --bg:#fbfbfc;
      --card:#ffffff;
      --muted:#6b6f76;
      --accent:#c8102e; /* SRT red */
      --glass: rgba(0,0,0,0.04);
      --radius:14px;
      font-family: Inter, system-ui, -apple-system, 'Noto Sans Thai', sans-serif;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;background:linear-gradient(180deg,var(--bg),#f7f7f8);color:#111}

    .wrap{max-width:920px;margin:36px auto;padding:28px;}
    header{display:flex;align-items:center;gap:16px;margin-bottom:18px}
    .logo{display:flex;align-items:center;gap:10px}
    .srt-mark{width:48px;height:48px;border-radius:12px;display:grid;place-items:center;background:linear-gradient(180deg,#fff,#fff);box-shadow:0 2px 6px var(--glass)}
    .srt-mark svg{width:34px;height:34px}
    h1{font-size:18px;margin:0}
    p.lead{margin:0;color:var(--muted);font-size:13px}

    .controls{display:flex;gap:10px;margin-top:12px;flex-wrap:wrap}
    .seg{background:var(--card);border-radius:12px;padding:8px;border:1px solid rgba(0,0,0,0.04);display:inline-flex;gap:6px;align-items:center}
    .seg button{background:transparent;border:none;padding:8px 12px;border-radius:10px;font-weight:600}
    .seg button.active{background:linear-gradient(90deg, rgba(200,16,46,0.08), rgba(200,16,46,0.03));color:var(--accent)}

    main{display:grid;grid-template-columns:360px 1fr;gap:18px;margin-top:18px}

    .panel{background:var(--card);border-radius:16px;padding:16px;border:1px solid rgba(0,0,0,0.04);box-shadow:0 6px 22px rgba(12,12,15,0.04)}

    /* big focus card */
    .focus{display:flex;flex-direction:column;gap:12px}
    .train-title{display:flex;align-items:center;justify-content:space-between}
    .train-title .meta{display:flex;gap:10px;align-items:center}
    .number{font-weight:800;font-size:22px;color:var(--accent)}
    .time{font-size:16px;color:#222}
    .countdown{font-size:36px;font-weight:800;letter-spacing:1px}
    .count-label{color:var(--muted);font-size:13px}

    .progress-rail{height:44px;background:linear-gradient(90deg,#f0f0f0,#fafafa);border-radius:22px;position:relative;overflow:hidden;border:1px solid rgba(0,0,0,0.03)}
    .progress-track{position:absolute;left:0;top:0;bottom:0;width:100%;}
    .train-icon{position:absolute;top:50%;transform:translate(-50%,-50%);height:36px;width:64px}

    .list{display:flex;flex-direction:column;gap:10px}
    .item{display:flex;align-items:center;justify-content:space-between;padding:10px;border-radius:12px}
    .item .left{display:flex;gap:10px;align-items:center}
    .dot{width:8px;height:8px;border-radius:50%;background:var(--accent);opacity:0.88}
    .small{font-size:13px;color:var(--muted)}

    footer{margin-top:16px;color:var(--muted);font-size:13px}

    /* responsive */
    @media (max-width:820px){main{grid-template-columns:1fr;}}

    /* tiny helpers */
    .tag{background:rgba(0,0,0,0.03);padding:4px 8px;border-radius:999px;font-size:12px}
    .muted{color:var(--muted)}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="logo">
        <div class="srt-mark" title="SRT">
          <!-- simple SRT-ish mark -->
          <svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg" aria-hidden>
            <circle cx="50" cy="50" r="44" fill="none" stroke="#c8102e" stroke-width="8" />
            <text x="50%" y="55%" text-anchor="middle" font-size="36" font-weight="700" fill="#c8102e" font-family="sans-serif">SRT</text>
          </svg>
        </div>
        <div>
          <h1>Countdown ขึ้นรถไฟ — บางซื่อ ↔ เชียงราก</h1>
          <p class="lead">เลือกทิศทาง ดูขบวนที่กำลังจะมาถึง หรืออยู่ระหว่างทาง (เดินทาง ~1 ชั่วโมง)</p>
        </div>
      </div>
    </header>

    <div class="controls">
      <div class="seg">
        <button id="dir-bs-cr" class="active">บางซื่อ → เชียงราก</button>
        <button id="dir-cr-bs">เชียงราก → บางซื่อ</button>
      </div>
     
    </div>

    <main>
      <section class="panel focus" aria-live="polite">
        <div class="train-title">
          <div class="meta">
            <div class="number" id="focus-number">-</div>
            <div>
              <div class="time" id="focus-route">-</div>
              <div class="small muted" id="focus-extra">-</div>
            </div>
          </div>
          <div style="text-align:right">
            <div class="count-label" id="count-label">-</div>
            <div class="countdown" id="countdown">--:--:--</div>
          </div>
        </div>

        <div>
          <div class="progress-rail" aria-hidden>
            <div class="progress-track" id="progress-track"></div>
            <!-- train icon (will be positioned by JS) -->
            <svg class="train-icon" id="train-icon" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
              <rect x="1" y="6" width="22" height="9" rx="2" fill="#fff" stroke="#c8102e" stroke-width="0.9"></rect>
              <circle cx="7.5" cy="17.2" r="1.5" fill="#222" opacity="0.9"></circle>
              <circle cx="16.5" cy="17.2" r="1.5" fill="#222" opacity="0.9"></circle>
              <path d="M4 8h16" stroke="#c8102e" stroke-width="0.8" opacity="0.6"/>
            </svg>
          </div>
        </div>

      </section>

      <aside class="panel">
        <h3 style="margin-top:0;margin-bottom:12px">ขบวนที่กำลังจะมาถึง</h3>
        <div class="list" id="train-list">
          <!-- JS will populate -->
        </div>
      </aside>
    </main>

  </div>

  <script>
    // schedules: times are HHMM as strings
    const schedules = {
      'BS-CR': [
        {num:'341', time:'1724'},
        {num:'317', time:'1753', note:'(จันทร์-ศุกร์)'},
        {num:'313', time:'1843', note:'(จันทร์-ศุกร์)'}
      ],
      'CR-BS': [
        {num:'210', time:'1916'}
      ]
    };

    // UI refs
    const dirBsBtn = document.getElementById('dir-bs-cr');
    const dirCrBtn = document.getElementById('dir-cr-bs');
    const trainList = document.getElementById('train-list');
    const focusNumber = document.getElementById('focus-number');
    const focusRoute = document.getElementById('focus-route');
    const focusExtra = document.getElementById('focus-extra');
    const countdownEl = document.getElementById('countdown');
    const countLabelEl = document.getElementById('count-label');
    const progressTrack = document.getElementById('progress-track');
    const trainIcon = document.getElementById('train-icon');

    let currentDir = 'BS-CR';

    dirBsBtn.onclick = ()=>{ setDir('BS-CR'); }
    dirCrBtn.onclick = ()=>{ setDir('CR-BS'); }

    function setDir(d){
      currentDir = d;
      dirBsBtn.classList.toggle('active', d==='BS-CR');
      dirCrBtn.classList.toggle('active', d==='CR-BS');
      render();
    }

    function getTodaySchedule(dir){
      const now = new Date();
      const list = schedules[dir].map(s => {
        const hh = parseInt(s.time.slice(0,2),10);
        const mm = parseInt(s.time.slice(2,4),10);
        const dep = new Date(now.getFullYear(), now.getMonth(), now.getDate(), hh, mm, 0, 0);
        return {...s, dep};
      });
      return list;
    }

    function update(){
      const now = new Date();
      const list = getTodaySchedule(currentDir)
        .map(s=>{
          const dep = s.dep.getTime();
          const arrival = dep + 60*60*1000; // 1 hour journey
          const toArrival = arrival - now.getTime();
          return {...s, depTs:dep, arrivalTs:arrival, toArrival};
        })
        .filter(s=>s.toArrival > -1*60*1000) // keep trains whose arrival isn't long passed (allow 1 min leeway)
        .sort((a,b)=>a.toArrival - b.toArrival);

      // top train is first
      if(list.length===0){
        focusNumber.textContent='-';
        focusRoute.textContent='ไม่มีขบวนที่ใกล้เข้ามา';
        focusExtra.textContent='โปรดตรวจสอบอีกครั้งในภายหลัง';
        countdownEl.textContent='--:--:--';
        countLabelEl.textContent='-';
        trainList.innerHTML='<div class="small muted">ไม่มีขบวนคงค้างหรือกำลังมาถึงภายใน 1 ชั่วโมง</div>';
        // hide train icon
        trainIcon.style.display='none';
        progressTrack.style.background='';
        return;
      }

      trainIcon.style.display='block';

      const top = list[0];
      const nowMs = now.getTime();
      const depMs = top.depTs;
      const arrivalMs = top.arrivalTs;

      const inProgress = nowMs >= depMs && nowMs <= arrivalMs;
      // countdown shows time to departure (if upcoming) or time to arrival (if in progress)
      let diffMs, label;
      if(inProgress){
        diffMs = arrivalMs - nowMs;
        label = 'เหลือเวลา ถึงปลายทาง';
      } else {
        diffMs = depMs - nowMs;
        label = 'เหลือเวลา ถึงเวลาออก';
      }

      countLabelEl.textContent = label;
      countdownEl.textContent = formatHMS(diffMs);

      focusNumber.textContent = top.num + (top.note? ' ' + top.note: '');
      focusRoute.textContent = currentDir==='BS-CR' ? 'บางซื่อ → เชียงราก • ออก ' + hhmmFromTs(top.depTs) : 'เชียงราก → บางซื่อ • ออก ' + hhmmFromTs(top.depTs);
      focusExtra.textContent = inProgress ? 'กำลังเดินทาง — ถึงปลายทางประมาณ ' + hhmmFromTs(top.arrivalTs) : 'ออกตอน ' + hhmmFromTs(top.depTs) + ' • ประมาณ 1 ชั่วโมงถึงปลายทาง';

      // progress: fraction of journey completed [0..1]
      let frac = 0;
      if(nowMs < depMs) frac = 0;
      else if(nowMs >= arrivalMs) frac = 1;
      else frac = (nowMs - depMs) / (arrivalMs - depMs);

      // update visual progress: create a gradient for filled portion and position train icon
      const pct = Math.round(frac * 100);
      progressTrack.style.background = `linear-gradient(90deg, rgba(200,16,46,0.14) ${pct}%, transparent ${pct}%)`;

      // position train icon relative to rail width
      // measure rail width
      const rail = document.querySelector('.progress-rail');
      const railRect = rail.getBoundingClientRect();
      const leftPx = Math.max(12, Math.min(railRect.width-12, Math.round((railRect.width) * frac)));
      trainIcon.style.left = leftPx + 'px';

      // render list of trains
      trainList.innerHTML = '';
      list.forEach(item=>{
        const el = document.createElement('div');
        el.className = 'item';
        const left = document.createElement('div');
        left.className='left';
        const dot = document.createElement('div'); dot.className='dot';
        left.appendChild(dot);
        const txt = document.createElement('div');
        txt.innerHTML = `<div style="font-weight:700">ขบวน ${item.num} ${item.note? '<span class=muted style="font-weight:600;padding-left:6px">'+item.note+'</span>':''}</div><div class=small>${hhmmFromTs(item.depTs)} • ถึงประมาณ ${hhmmFromTs(item.arrivalTs)}</div>`;
        left.appendChild(txt);
        const right = document.createElement('div');
        right.style.textAlign='right';
        const nowMs = Date.now();
        const toDeparture = item.depTs - nowMs;
        const toArrival = item.arrivalTs - nowMs;
        let rightText='';
        if(nowMs < item.depTs) rightText = `<div style="font-weight:700">ออกใน ${formatFriendly(toDeparture)}</div>`;
        else if(nowMs >= item.depTs && nowMs <= item.arrivalTs) rightText = `<div style="font-weight:700">กำลังเดินทาง — ถึงใน ${formatFriendly(toArrival)}</div>`;
        else rightText = `<div class=small>ออกแล้ว</div>`;
        right.innerHTML = rightText;

        el.appendChild(left);
        el.appendChild(right);
        trainList.appendChild(el);
      });
    }

    function render(){
      update();
    }

    function hhmmFromTs(ts){
      const d = new Date(ts);
      const hh = String(d.getHours()).padStart(2,'0');
      const mm = String(d.getMinutes()).padStart(2,'0');
      return `${hh}:${mm}`;
    }

    function formatHMS(ms){
      if(ms < 0) ms = 0;
      const s = Math.floor(ms/1000);
      const hh = Math.floor(s/3600);
      const mm = Math.floor((s%3600)/60);
      const ss = s%60;
      return `${String(hh).padStart(2,'0')}:${String(mm).padStart(2,'0')}:${String(ss).padStart(2,'0')}`;
    }

    function formatFriendly(ms){
      if(ms < 0) return 'น้อยกว่า 1 วินาที';
      const s = Math.floor(ms/1000);
      if(s < 60) return `${s} วินาที`;
      const m = Math.floor(s/60);
      if(m < 60) return `${m} นาที`;
      const h = Math.floor(m/60);
      return `${h} ชม ${m%60} นาที`;
    }

    // initial
    setDir('BS-CR');
    // update each second
    setInterval(update, 1000);

    // accessibility: update on visibility change
    document.addEventListener('visibilitychange', ()=>{ if(!document.hidden) update(); });

  </script>
</body>
</html>
